extends ./layout

block content

  h1= id

  .digital#my-time 20

  button#start START
  button#stop STOP

  ul#user-list

  button#start start
  button#stop stop
  script(type='text/javascript' src='/socket.io/socket.io.js')
  script(type='text/javascript' data-name=name data-session-id=id id='main').
    (function() {
      var socket = io();
      var name = $('#main').data('name');
      var id = $('#main').data('session-id');
      var isHakaring = false;

      //------------------------------------------------------------------
      // ログインに関する処理
      //------------------------------------------------------------------
      // ログインをサーバに通知

      socket.emit('join', {name: name, id: id});
      // 他のユーザのログインを取得
      socket.on('joined', function (data) {
        console.log(data);
        $('#user-list').append('<li>' + data.name + '</li>');
      });

      // 現在ログインしているユーザの一覧を取得
      socket.on('list-user', function (data) {
        console.log(data.users);
        data.users.forEach(function (name, index, arr) {
          $('#user-list').append('<li>' + name + '</li>');
        });
      });

      //------------------------------------------------------------------
      // 時間に関する処理
      //------------------------------------------------------------------
      $('#start').on("click", function () {
        socket.emit('start', {name: name, id: id});
        console.log('clicked');
      });

      socket.on('start', function (data) {
        console.log(data);
        $('li').each(function () {
          if (data.name == $(this).text()) {
            $(this).css('color', 'Red');
          }
        });
      });

      $('#stop').on("click", function () {
        socket.emit('stop', {name: name, id: id});
        console.log('clicked');
      });

      socket.on('stop', function (data) {
        console.log(data);
        $('li').each(function () {
          if (data.name == $(this).text()) {
            $(this).css('color', 'Black');
          }
        });
      });

      function decrementTime() {
        var time = parseInt($('#my-time').text());
        if ( time > 0 && isHakaring ) {
          setTimeout(decrementTime, 1000);
          time--;
          $('#my-time').text(time);
        }
      }

      $('#start').on('click', function () {
        isHakaring = true;
        decrementTime();
      });

      $('#stop').on('click', function () {
        isHakaring = false;
      });
    }).call(this);
